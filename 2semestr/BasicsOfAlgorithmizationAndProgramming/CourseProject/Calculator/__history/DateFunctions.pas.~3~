unit DateFunctions;

interface
uses
  System.SysUtils;

type
 TRDiffresult = record
 days:integer;
 weeks:integer;
 years:integer;
 AllDays:integer;
 end;
const tdays:array[1..12]of integer=(31,28,31,30,31,30,31,31,30,31,30,31);// Массив количеств дней в месяцах
const Сnamemonths:array[1..12] of string[10]=('Января','Февраля','Марта','Апреля','Мая','Июня','Июля','Августа','Сентября','Октября','Ноября','Декабря');
var date_1:string;
date_2:string;
diffresult:TRDiffResult;
function checknum(x:string):boolean;//  Функция для проверки введенной строки
procedure fordate(a:integer;var s:string);//процедура для перевода дней и месяцев в строку формата (ddmm)
procedure prepare(var a,b,c:integer;k:string);
procedure ConvToDate(a,b,c:integer;var s:string); // процедура для перевода дней,месяцев,лет в формат даты
procedure obm(var a,b:integer); //Процедура обмена значений двух переменных
function difference(date_1,date_2:string):TRDiffresult;//Функция разницы между датами
function SUmdays(x:integer;months,years:integer;date_1:string):string;// функция добавления дней,месяцев,лет к дате
function Subtractdays(x:integer;months,years:integer;date_1:string):string;// Функция вычитания дней,месяцев,лет от даты
function leapyearcheck(y:integer):boolean;//функция проверки года на високосность
function ResultOutput(date:string):string;//функция перевод даты формата ddmmyyyy  в формат "10 марта 2010 года"
implementation
function ResultOutput(date:string):string;
var d,m,y:integer;
begin
if date='Дата выходит за границы!' then
result:=date
else
begin
d:=strtoint(copy(date,1,2));
m:=strtoint(copy(date,4,2));
y:=strtoint(copy(date,7,length(date)-6));
result:=inttostr(d)+' '+string(Сnamemonths[m])+' '+inttostr(y)+' '+'Года';
end;
end;
function checknum(x:string):boolean;
var ch:string;
i:integer;
begin
ch:='0123456789';
i:=1;
while (i<=length(x)) and (pos(x[i],ch)<>0) do  //Проход по строке и проверка всех символов
begin
 inc(i);
end;
if (i<=length(x)) or (x='')  then   //если найден неподходящий символ,то результат-false, иначе результат-true
begin
result:=false;
end
else
result:=true;
end;
procedure fordate(a:integer;var s:string);
begin
 if a<=9 then     //если число меньше 10,то перед ним нужно добавить 0
    begin
      s:=s+'0';
      s:=s+inttostr(a);     //приписание к концу строки
    end
    else
    s:=s+inttostr(a);     //приписание к концу строки
end;
procedure ConvToDate(a,b,c:integer;var s:string);
begin
s:='';
fordate(a,s);         //Сначало конвертация дней
fordate(b,s);         //Затем месяцев
  case c of               //Конвертация номера года
    0..9:s:=s+'000';      //Если год однозначное число,то нужно добавить перед ним "000"
    10..99:s:=s+'00';     //Если двухзначное,то нужно добавить "00"
    100..999:s:=s+'0';    //Если однозначное,то нужно добавить "0"
  end;
insert('.',s,3);      //Добавление точек к строке
insert('.',s,6);
s:=s+inttostr(c);   //Добавление номера года к строке
end;
procedure obm(var a,b:integer);
var tmp:integer;
begin
  tmp:=a;
  a:=b;
  b:=tmp;
end;
//Процедура помещает в переданные параметры номера дня, месяца,года из даты формата "dd.mm.yyyy"
procedure prepare(var a,b,c:integer;k:string);
var i:integer;
begin
delete(k,3,1);     //Удаление точек из строки
delete(k,5,1);
 while k<>'' do
  begin
    for i := 1 to 3 do
    begin
    case i of
       1:begin              //Помещение номера дня
         if k[1]='0' then
         begin
           delete(k,1,1);
           a:=strtoint(k[1]);
           delete(k,1,1);
         end
         else
         begin
          a:=strtoint(copy(k,1,2));
          delete(k,1,2);
         end;
       end;
       2:                 //Помещение номера месяца
       begin
          if k[1]='0' then
         begin
           delete(k,1,1);
           b:=strtoint(k[1]);
           delete(k,1,1);
         end
         else
         begin
          b:=strtoint(copy(k,1,2));
          delete(k,1,2);
         end;
       end;
       3:             //Помещение номера года
        begin
         while (k[1]='0')  do
         begin
         delete(k,1,1);
         end;
         c:=strtoint(copy(k,1,length(k)));
         delete(k,1,length(k));
       end;
    end;
    end;
  end;
end;
function difference(date_1,date_2:string):TRDiffresult;
var d1,d2,m1,m2,y1,y2:integer;
dy:integer;
i,weeks,days,counter:integer;
diff:integer;
years:integer;
begin
 counter:=0;
 prepare(d1,m1,y1,date_1);
 prepare(d2,m2,y2,date_2);
 if y1<y2 then
 begin
   obm(y1,y2);
   obm(d1,d2);
   obm(m1,m2);
 end;
 dy:=y1-y2;              //Найти разницу в годах между датами
 diff:=(dy-1)*365;       //Добавляем к разнице количество полных лет в днях
 if (y1-y2)>1 then
 begin
  for i := y2+1 to y1-1 do              //Проходимся по годам и если есть високосные добавляем еще по дню
 begin
   if ((leapyearcheck(i)=true)) then
   inc(counter);
 end;
 diff:=diff+counter;
 end;
 if (dy)>0 then                            //Если количество разница между номера лет двух дат больше 0
 begin
   for i :=(m2+1) to 12 do                     //Проходимся по месяцам меньшей даты с месяца следующего за текущим до конца года
     begin                                     // И добавляем к разнице количество дней в каждом из месяцев
       if (i=2) and ((leapyearcheck(y2)=true)) then
       inc(diff);                                     //если високосный год и февраль,то добавляем еще день
       diff:=diff+tdays[i];
     end;
   diff:=diff+tdays[m2]-d2;                       //Добавляем к разнице количество дней оставшихся до конца месяца в текущем месяце второй даты
   if (m2=2) and ((leapyearcheck(y2)=true)) then  //Если это високосный год,то добавляем еще день
   inc(diff);
  for i :=1 to m1-1 do                            //Проходимся от начала года до месяца, предшествующего текущему месяцу первой даты
    begin
      if (i=2) and (leapyearcheck(y1)=true) then  //Если високосный год и февраль,то добавляю еще днеь
      inc(diff);
      diff:=diff+tdays[i]                        //Добавляем к разнице количество дней в месяце
    end;
   diff:=diff+d1;
 end
 else
 begin
    diff:=0;
    if m1=m2 then         //Если месяца дат совпадают, то разница равна разнице между номерами дней
      diff:=abs(d1-d2)
    else
      begin
      if m2>m1 then       //Если вторая дата больше, то меняем местами
      begin
       obm(m1,m2);
       obm(d1,d2);
      end;
      diff:=diff+abs(tdays[m2]-d2);//Добавляем к разнице количество дней
      if ((leapyearcheck(y2)=true)) and (m2=2) then    /// недостающих во второй дате для перехода на следующий месяе
       inc(diff);
      diff:=diff+d1;         //Добавляем к разнице номер дня первой даты
      if abs(m1-m2)>1 then       //Если в датах не содержатся соседние месяца
      begin
        for i := m2+1 to m1-1 do    //Проход по месяцам между двумя датами
        begin
          diff:=diff+tdays[i];       //Добавление к разнице количества дней в этих месяцах
          if (leapyearcheck(y2)=true) and (i=2) then  //Если попался високосный год  и 2 месяц,то еще день добавляю
          inc(diff);
        end;
      end;
    end;
 end;
   result.AllDays:=diff;      //Разница в виде числа дней
   years:=diff div 365;        //Находим разницу в формате года+недели+дни
   weeks:=(diff-years*365)div 7;
   days:=diff-(weeks*7)-years*365;
   result.days:=days;
   result.weeks:=weeks;
   result.years:=years;
end;
function LeapYearCheck(y:integer):boolean;
begin
     if (y mod 4 = 0) or (y mod 400= 0) then
     begin
       if (y mod 100=0) then
         result:=false
       else
       result:=true;
     end
     else
     result:=false;
end;
function SUmdays(x:integer;months,years:integer;date_1:string):string;
var tmp:integer;m,d,y:integer;
begin
 prepare(d,m,y,date_1);   // Помещение в переменные номера дня, месяца, года
 tmp:=tdays[m]-d+1;// помещаем количество дней до перехода на следующий месяц
if (leapyearcheck(y)=true) and (m=2) then //Проверка на високосность года и на февраль
inc(tmp);
if x<tmp then //если число добавляемых дней меньше, чем нужно для перехода на следующий месяц
begin
  d:=d+x;
end
else
begin
  repeat
      tmp:=tdays[m]-d+1;
      if (leapyearcheck(y)=true) and (m=2) then
      inc(tmp);
      x:=x-tmp;    //Отнимаем от добавляемых дней число дней, необходимое для перехода не след месяц
      if m=12 then  //Если номер месяца-12,то переход на первый месяц следующего года
      begin
        m:=1;
        y:=y+1;
      end
      else         //иначе переход на следующий месяц текущего года
      m:=m+1;
      d:=1;
  until x<tdays[m];
d:=d+x;     //Добавление к номеру дня, оставщихся дней
end;
if months<13-m then    //Если количество добавляемых месяцев меньше, чем нужно для перехода на следующий гол
 m:=m+months
else
begin       //Иначе
  repeat
    y:=y+1;      //Изменение года
    months:=months-(13-m);  //Изменение добавляемых месяцев
    m:=1;                   //Присваивание номеру месяца единицы
  until months<13-m ;//Пока количество добавляемых месяцев не меньше,чем нужно для перехода на следующий год
  m:=m+months;
end;
y:=y+years;
 result:='';
 convtodate(d,m,y,result);//Конвертация в формат даты
end;

function Subtractdays(x:integer;months,years:integer;date_1:string):string;
var m,d,y:integer;
begin
 prepare(d,m,y,date_1);   //Помещаем в переменные номер дня, месяца, года
if x>=d then
begin
 repeat
 x:=x-d;                 //Отнимаем текущее число дней в месяце
 if m=1 then            // Если месяц был первым, то меняем на последний месяц предыдущего года
 begin
    m:=12;
    dec(y);
 end
 else
  dec(m);                              //В ином случает меняем число месяца
  d:=tdays[m];                          //Текущему числу дней присваиваем количество дней,равное дням в месяце
  if ((leapyearcheck(y)=true)) and (m=2) then  //Проверка на високосный год и месяц февраль
  inc(d);
 until x<d ;                               //До тех пор,пока количество отнимаемых дней не станет меньше текушего числа дней месяца                                //Отнимаем от текущего числа оставшиеся дни
end;
d:=d-x;
if months>=m then                      //Количество отнимаемых месяцев больше либо равно номеру текущего месяца
begin
  repeat                               //Если да,то повторять:
     months:=months-m;                 //От отнимаемого числа месяца отнимаем номер текущего месяца
     m:=12;                            //Переход на 12 месяц предыдущего года
     dec(y);                           //
  until months<m;                      //До тех пор, пока число отнимаемых месяцев не станет меньше номера текущего месяца
end;
m:=m-months;                           //Изменить номер текущего месяца
y:=y-years;                            //Изменить год текущего месяца
 result:='';
if y<0 then                             //Перевод результата в нужный формат
result:='Дата выходит за границы!'
else
convtodate(d,m,y,result);
end;

end.
